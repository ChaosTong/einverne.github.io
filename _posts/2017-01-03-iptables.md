---
layout: post
title: "每天学习一个命令：iptables Linux 上的防火墙"
tagline: ""
description: ""
category: 学习笔记
tags: [iptables, firewall, linux, network, command,]
last_updated:
---

iptables 命令是 Linux 上常用的防火墙软件，是 netfilter 项目的一部分。可以直接配置，也可以通过许多前端和图形界面配置。这篇文章主要介绍 iptables 的安装，添加规则，清除规则，开放指定端口，屏蔽指定 ip，ip 段，等等基本功能。

## 安装

    apt-get install iptables

iptables 防火墙用于创建过滤规则和 NAT 规则，所有发行版都能使用。 iptables 的结构 iptables -> Tables -> Chains -> Rules ，简单地，Tables 由 Chains 组成，Chains 又由 Rules 组成。

## 组成
iptables 具有 Filter，NAT，Mangel，Raw 四种内建表

## 常见用法

清除已有 iptables 规则

    iptables -F     # 刷新所有链
    iptables -X     # 删除表中所有非默认链

允许本地回环接口（即运行本机访问本机）

    iptables -A INPUT -i lo -j ACCEPT
    iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT

允许所有本机向外的访问

    iptables -A OUTPUT -j ACCEPT

允许访问 22 端口，允许某 IP 访问指定端口，以 22 端口为例命令是

    iptables -A INPUT -p tcp --dport 22 -j ACCEPT                         # 允许所有的 IP 访问 22 端口
    iptables -I INPUT -s 123.45.6.7 -p tcp --dport 22 -j ACCEPT           # 允许某个 IP 访问
    iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT       # 允许 IP 段访问

允许访问 80 端口

    iptables -A INPUT -p tcp --dport 80 -j ACCEPT

允许 FTP 服务的 21 和 20 端口

    iptables -A INPUT -p tcp --dport 21 -j ACCEPT
    iptables -A INPUT -p tcp --dport 20 -j ACCEPT

如果有其他端口稍微修改上述语句中的端口号即可

允许已建立的或相关连的通行

    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

## 禁止访问
禁止其他未允许的规则访问

**注意**：如果 22 端口未加入允许规则，SSH 链接会直接断开

屏蔽单个 IP 的命令是

    iptables -I INPUT -s 123.45.6.7 -j DROP

封整个段即从 123.0.0.1 到 123.255.255.254 的命令

    iptables -I INPUT -s 123.0.0.0/8 -j DROP

封 IP 段即从 123.45.0.1 到 123.45.255.254 的命令

    iptables -I INPUT -s 124.45.0.0/16 -j DROP

封 IP 段即从 123.45.6.1 到 123.45.6.254 的命令是

    iptables -I INPUT -s 123.45.6.0/24 -j DROP

屏蔽某 IP 访问指定端口，以 22 端口为例命令是

    iptables -I INPUT -s 123.45.6.7 -p tcp --dport 22 -j DROP


## 查看规则

查看已添加的 iptables 规则

    iptables -L -n
    iptables -nvL --line-numbers

- n：只显示 IP 地址和端口号，不将 ip 解析为域名

将所有 iptables 以序号标记显示

    iptables -L -n --line-numbers

## 删除规则
删除已添加的 iptables 规则

比如要删除 INPUT 里序号为 8 的规则，执行：

    iptables -D INPUT 8

## 保存和恢复配置规则
保存生效的配置，让系统重启的时候自动加载有效配置（iptables 提供了保存当前运行的规则功能）

    iptables-save > /etc/iptables.rules
    iptables-restore < /etc/iptables.rules

## reference

- <https://www.vpser.net/security/linux-iptables.html>
- <https://wiki.archlinux.org/index.php/Iptables>
